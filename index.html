<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kannada Baruthe, Boss</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#34D399"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .heatmap-day { transition: all 0.2s ease-in-out; }
        .heatmap-day:hover { transform: scale(1.2); }
        .recording { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .correct-answer { background-color: #A7F3D0 !important; }
        .incorrect-answer { background-color: #FECACA !important; }
        /* Styles for the TTS Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-emerald-50 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <!-- App Header -->
        <header id="app-header" class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-emerald-700">Kannada Baruthe, Boss</h1>
            <div class="flex items-center space-x-4">
                <div id="user-profile" class="flex items-center space-x-2 cursor-pointer">
                    <span id="username-display" class="font-semibold">Cara</span>
                    <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                    <img id="profile-pic" src="https://placehold.co/40x40/34D399/FFFFFF?text=C" class="rounded-full w-10 h-10 object-cover" alt="Profile Picture">
                </div>
                <button id="author-mode-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Author Mode</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <h3 class="font-bold text-lg">Streak</h3>
                        <p class="text-3xl text-emerald-500"><span id="streak-days">0</span> Days</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <h3 class="font-bold text-lg">Words Learned</h3>
                        <p class="text-3xl text-emerald-500" id="words-learned">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <h3 class="font-bold text-lg">Accuracy</h3>
                        <p class="text-3xl text-emerald-500" id="accuracy-percent">0%</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h2 class="text-2xl font-bold mb-4">Your Progress</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold mb-2 text-center">Daily Activity</h3>
                            <div id="calendar-heatmap" class="flex justify-center"></div>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-2 text-center">Accuracy Trend</h3>
                            <div id="accuracy-chart" class="flex justify-center items-end h-48"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Modules</h2>
                    <div id="modules-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mt-6">
                    <h2 class="text-2xl font-bold mb-4">Mini-Games</h2>
                    <div id="minigames-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button id="speed-match-btn" class="bg-teal-100 p-4 rounded-xl shadow-md text-center cursor-pointer hover:bg-teal-200 transition">
                            <div class="text-4xl mb-2">‚è±Ô∏è</div>
                            <h3 class="font-bold">Speed Match</h3>
                        </button>
                        <button id="memory-grid-btn" class="bg-amber-100 p-4 rounded-xl shadow-md text-center cursor-pointer hover:bg-amber-200 transition">
                            <div class="text-4xl mb-2">üß†</div>
                            <h3 class="font-bold">Memory Grid</h3>
                        </button>
                        <button id="trivia-game-btn" class="bg-purple-100 p-4 rounded-xl shadow-md text-center cursor-pointer hover:bg-purple-200 transition">
                            <div class="text-4xl mb-2">üåç</div>
                            <h3 class="font-bold">Trivia</h3>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lesson View -->
            <div id="lesson-view" class="hidden">
                <div id="focus-mode-header" class="flex justify-between items-center mb-4">
                     <h2 id="lesson-title" class="text-2xl font-bold"></h2>
                     <div id="lesson-timer" class="text-lg font-mono bg-gray-200 px-3 py-1 rounded-lg">00:00</div>
                </div>
                 <!-- Activity: Flashcard -->
                <div id="flashcard-activity" class="hidden bg-white p-6 rounded-xl shadow-md">
                     <canvas id="flashcard-canvas" class="w-full h-64 rounded-lg bg-gray-100 cursor-pointer"></canvas>
                     <div class="flex justify-around mt-4">
                        <button id="flashcard-wrong" class="bg-red-500 text-white font-bold py-3 px-6 rounded-lg text-lg">Again</button>
                        <button id="flashcard-right" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg">Got it!</button>
                     </div>
                </div>
            </div>
            
            <!-- Game View -->
            <div id="game-view" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 id="game-title" class="text-2xl font-bold"></h2>
                    <button id="exit-game-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Exit Game</button>
                </div>
                <div id="game-container" class="bg-white p-4 rounded-xl shadow-md">
                    <!-- Game content will be dynamically inserted here -->
                </div>
            </div>

            <!-- Author Mode View -->
            <div id="author-mode-view" class="hidden bg-white p-6 rounded-xl shadow-md"></div>
        </main>
    </div>

    <!-- All Modals -->
    <div id="passcode-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="trivia-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>


    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- GOOGLE CLOUD TTS CONFIG ---
        const GOOGLE_API_KEY = "PASTE_YOUR_API_KEY_HERE";

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }

        // --- DATABASE ---
        const DB_NAME = 'KannadaBarutheBossDB';
        const DB_VERSION = 1;
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = e => reject("DB error: " + e.target.errorCode);
                request.onupgradeneeded = e => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains('modules')) db.createObjectStore('modules', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('userData')) db.createObjectStore('userData', { keyPath: 'key' });
                    if (!db.objectStoreNames.contains('srs')) db.createObjectStore('srs', { keyPath: 'phraseId' });
                    if (!db.objectStoreNames.contains('progressLog')) db.createObjectStore('progressLog', { keyPath: 'date' });
                };
                request.onsuccess = e => {
                    db = e.target.result;
                    console.log("DB initialized.");
                    resolve(db);
                };
            });
        }
        
        function getStore(storeName, mode) { return db.transaction(storeName, mode).objectStore(storeName); }
        
        function addOrUpdate(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                store.put(data);
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => {
                    console.error(`Transaction error on store ${storeName}:`, event.target.error);
                    reject("DB Error: " + event.target.error);
                };
            });
        }

        async function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                store.clear();
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => {
                    console.error(`Transaction error on store ${storeName}:`, event.target.error);
                    reject("DB Error: " + event.target.error);
                };
            });
        }
        
        function getData(storeName, key) { return new Promise((resolve, reject) => { const req = getStore(storeName, 'readonly').get(key); req.onsuccess = () => resolve(req.result); req.onerror = e => reject("DB Error: " + e.target.error); }); }
        function getAllData(storeName) { return new Promise((resolve, reject) => { const req = getStore(storeName, 'readonly').getAll(); req.onsuccess = () => resolve(req.result); req.onerror = e => reject("DB Error: " + e.target.error); }); }

        // --- SEED DATA & CONFIG ---
        const moduleOrder = ["greetings", "numbers", "directions", "eating", "shopping", "home", "smalltalk", "family"];
        const seedModules = [
            {"id":"greetings","title":"Greetings & Introductions","icon":"üëã","phrases":[{"id":1,"en":"Hello","kn":"Namaskara","translit":"na-mas-ka-ra"}]},
            {"id":"numbers","title":"Numbers & Time","icon":"üî¢","phrases":[{"id":51,"en":"One","kn":"Ondu","translit":"on-du"}]},
            {"id":"directions","title":"Directions & Transport","icon":"üöÉ","phrases":[{"id":101,"en":"Where is...?","kn":"... ellide?","translit":"el-li-de"}]},
            {"id":"eating","title":"Eating Out","icon":"üçΩÔ∏è","phrases":[{"id":151,"en":"Restaurant","kn":"Upahara gruha","translit":"u-pa-haa-ra gru-ha"}]},
            {"id":"shopping","title":"Shopping & Money","icon":"üõçÔ∏è","phrases":[{"id":201,"en":"How much is this?","kn":"Idara bele eshtu?","translit":"i-da-ra be-le esh-tu"}]},
            {"id":"home","title":"At Home & Chores","icon":"üè†","phrases":[{"id":251,"en":"House","kn":"Mane","translit":"ma-ne"}]},
            {"id":"smalltalk","title":"Social Small Talk","icon":"üí¨","phrases":[{"id":301,"en":"How was your day?","kn":"Nimma dina hegittu?","translit":"nim-ma di-na he-git-tu"}]},
            {"id":"family","title":"Family & Relationships","icon":"üë®‚Äçüë©‚Äçüëß‚Äçüë¶","phrases":[{"id":351,"en":"Family","kn":"Kutumba","translit":"ku-tum-ba"}]}
        ];
        const karnatakaTrivia = [
            { q: "What is the capital city of Karnataka?", options: ["Mysuru", "Bengaluru", "Mangaluru", "Hubballi"], answer: "Bengaluru" },
            { q: "Which famous empire had its capital at Hampi?", options: ["Chalukya", "Hoysala", "Vijayanagara", "Rashtrakuta"], answer: "Vijayanagara" },
            { q: "What is the state animal of Karnataka?", options: ["Tiger", "Lion", "Elephant", "Leopard"], answer: "Elephant" },
            { q: "The Jog Falls, one of the highest waterfalls in India, is created by which river?", options: ["Kaveri", "Krishna", "Tungabhadra", "Sharavathi"], answer: "Sharavathi" },
            { q: "Which city in Karnataka is famous for its sandalwood products?", options: ["Bengaluru", "Mysuru", "Belagavi", "Davanagere"], answer: "Mysuru" },
            { q: "What is the traditional folk dance-drama of Karnataka?", options: ["Kathakali", "Bharatanatyam", "Yakshagana", "Kuchipudi"], answer: "Yakshagana" },
            { q: "The Gol Gumbaz, known for its incredible whispering gallery, is located in which city?", options: ["Bidar", "Kalaburagi", "Vijayapura", "Raichur"], answer: "Vijayapura" },
            { q: "Which of these is a famous national park in Karnataka, known for its tiger population?", options: ["Bandipur", "Gir", "Kaziranga", "Sundarbans"], answer: "Bandipur" },
            { q: "What is the staple food grain of Southern Karnataka?", options: ["Wheat", "Ragi (Finger Millet)", "Bajra", "Maize"], answer: "Ragi (Finger Millet)" },
            { q: "The ancient university town of Talakad, now buried in sand, is on the banks of which river?", options: ["Sharavathi", "Netravati", "Kaveri", "Tunga"], answer: "Kaveri" },
            { q: "Which famous Indian scientist and Bharat Ratna recipient was from Karnataka?", options: ["C.V. Raman", "Homi Bhabha", "A.P.J. Abdul Kalam", "S. Chandrasekhar"], answer: "C.V. Raman" },
            { q: "What is the famous sweet dish from Dharwad known for its unique texture?", options: ["Mysore Pak", "Dharwad Pedha", "Holige", "Chiroti"], answer: "Dharwad Pedha" },
            { q: "The Karnataka Khadi Gramodyoga Samyukta Sangha in Bengeri is the only unit in India that is authorized to manufacture what?", options: ["Sandalwood Oil", "Indian National Flag", "Mysore Silk Sarees", "Bidriware"], answer: "Indian National Flag" },
            { q: "Which coastal city in Karnataka is a major port and is known for its beaches?", options: ["Karwar", "Udupi", "Mangaluru", "Gokarna"], answer: "Mangaluru" },
            { q: "The Hoysala temples at Belur and Halebidu are famous for their intricate what?", options: ["Paintings", "Sculptures", "Inlay work", "Glasswork"], answer: "Sculptures" },
            { q: "What is the state bird of Karnataka?", options: ["Peacock", "Indian Roller", "Great Hornbill", "Parrot"], answer: "Indian Roller" },
            { q: "Which mountain range runs parallel to the coast of Karnataka?", options: ["Himalayas", "Vindhyas", "Aravallis", "Western Ghats"], answer: "Western Ghats" },
            { q: "The festival of 'Kambala' involves which sport?", options: ["Bullock Cart Race", "Cock Fight", "Buffalo Race", "Boat Race"], answer: "Buffalo Race" },
            { q: "Which city is known as the 'Silicon Valley of India'?", options: ["Hyderabad", "Pune", "Bengaluru", "Chennai"], answer: "Bengaluru" },
            { q: "The famous Mysore Palace is also known by what name?", options: ["Amba Vilas Palace", "Lalitha Mahal", "Jaganmohan Palace", "Cheluvamba Mansion"], answer: "Amba Vilas Palace" },
            { q: "Which river is considered the 'Ganges of the South' and is a lifeline for Karnataka?", options: ["Krishna", "Godavari", "Kaveri", "Tungabhadra"], answer: "Kaveri" },
            { q: "What is 'Bidriware'?", options: ["A type of silk", "A style of painting", "A metal handicraft", "A type of pottery"], answer: "A metal handicraft" },
            { q: "The highest peak in Karnataka is Mullayanagiri. It is part of which hill range?", options: ["Nandi Hills", "Baba Budangiri", "Chamundi Hills", "Agumbe Ghat"], answer: "Baba Budangiri" },
            { q: "Which city is famous for the Udupi Krishna Temple and its vegetarian cuisine?", options: ["Mangaluru", "Udupi", "Sringeri", "Dharmasthala"], answer: "Udupi" },
            { q: "The historical figure Kittur Rani Chennamma is known for her rebellion against whom?", options: ["The Mughals", "The Marathas", "The British", "The Portuguese"], answer: "The British" },
            { q: "What is the state flower of Karnataka?", options: ["Rose", "Jasmine", "Lotus", "Marigold"], answer: "Lotus" },
            { q: "The world's second largest monolithic statue, Gommateshwara, is located at which place?", options: ["Hampi", "Shravanabelagola", "Badami", "Aihole"], answer: "Shravanabelagola" },
            { q: "Which city is known for its unique style of sarees, woven with pure silk and gold zari?", options: ["Ilkal", "Mysuru", "Molakalmuru", "Dharwad"], answer: "Mysuru" },
            { q: "What is the name of the film industry based in Karnataka?", options: ["Tollywood", "Kollywood", "Sandalwood", "Mollywood"], answer: "Sandalwood" },
            { q: "The rock-cut cave temples at Badami are dedicated to which deities?", options: ["Shiva & Vishnu", "Brahma & Saraswati", "Ganesha & Kartikeya", "Rama & Sita"], answer: "Shiva & Vishnu" },
            { q: "Which king of the Ganga Dynasty commissioned the Gommateshwara statue?", options: ["Rachamalla IV", "Chavundaraya", "Butuga II", "Sripurusha"], answer: "Chavundaraya" },
            { q: "The famous 'Dasara' festival is celebrated with grand procession in which city?", options: ["Bengaluru", "Hassan", "Mysuru", "Shivamogga"], answer: "Mysuru" },
            { q: "Which region in Karnataka is famous for its coffee plantations?", options: ["Coorg (Kodagu)", "Kolar", "Raichur", "Ballari"], answer: "Coorg (Kodagu)" },
            { q: "The language 'Tulu' is predominantly spoken in which part of Karnataka?", options: ["North Karnataka", "Coastal Karnataka", "Old Mysore region", "Hyderabad-Karnataka"], answer: "Coastal Karnataka" },
            { q: "What is the name of the ISRO's satellite tracking centre located near Bengaluru?", options: ["ISTRAC", "SHAR", "VSSC", "SAC"], answer: "ISTRAC" },
            { q: "Which of these is a famous dish from North Karnataka made from sorghum?", options: ["Akki Rotti", "Jolada Rotti", "Ragi Mudde", "Neer Dosa"], answer: "Jolada Rotti" },
            { q: "The historical site of Aihole is often called the 'cradle of Indian temple architecture'. It was the capital of which dynasty?", options: ["Hoysala", "Chalukya", "Kadamba", "Ganga"], answer: "Chalukya" },
            { q: "Which famous writer from Karnataka won the Jnanpith Award for his work 'Mookajjiya Kanasugalu'?", options: ["U.R. Ananthamurthy", "Kuvempu", "Girish Karnad", "K. Shivaram Karanth"], answer: "K. Shivaram Karanth" },
            { q: "The Lalbagh Botanical Garden in Bengaluru is famous for its what?", options: ["Rose Garden", "Glass House", "Topiary Garden", "Japanese Garden"], answer: "Glass House" },
            { q: "Which city is considered the 'cradle of banking' in India?", options: ["Bengaluru", "Mangaluru", "Udupi", "Mysuru"], answer: "Udupi" },
            { q: "The river Tungabhadra is a major tributary of which river?", options: ["Godavari", "Krishna", "Kaveri", "Mahanadi"], answer: "Krishna" },
            { q: "What is the traditional attire for women in the Kodagu (Coorg) region?", options: ["Ghagra Choli", "Salwar Kameez", "Saree (draped in a unique style)", "Langa Voni"], answer: "Saree (draped in a unique style)" },
            { q: "The 'Hoysala' emblem depicts a man fighting what animal?", options: ["A lion", "An elephant", "A tiger", "A boar"], answer: "A tiger" },
            { q: "Which city is a major hub for the iron and steel industry in Karnataka?", options: ["Davanagere", "Ballari (Bellary)", "Tumakuru", "Chitradurga"], answer: "Ballari (Bellary)" },
            { q: "The 'Karaga' is a famous and ancient festival celebrated in which city?", options: ["Mysuru", "Bengaluru", "Kolar", "Hassan"], answer: "Bengaluru" },
            { q: "Which type of painting style, characterized by the use of gold foil, originated in Karnataka?", options: ["Madhubani", "Warli", "Tanjore", "Mysore Painting"], answer: "Mysore Painting" },
            { q: "The 'Nagarahole National Park' is also known by what other name?", options: ["Rajiv Gandhi National Park", "Indira Gandhi National Park", "Jawaharlal Nehru National Park", "Sanjay Gandhi National Park"], answer: "Rajiv Gandhi National Park" },
            { q: "Which famous dam is built across the Tungabhadra river near Hosapete?", options: ["Krishna Raja Sagara Dam", "Tungabhadra Dam", "Almatti Dam", "Linganamakki Dam"], answer: "Tungabhadra Dam" },
            { q: "The founder of the Vijayanagara Empire, Harihara I, belonged to which dynasty?", options: ["Sangama", "Saluva", "Tuluva", "Aravidu"], answer: "Sangama" },
            { q: "What is 'Bisi Bele Bath'?", options: ["A sweet dish", "A type of bread", "A spicy lentil rice dish", "A yogurt-based curry"], answer: "A spicy lentil rice dish" }
        ];
        
        async function seedDatabase() {
            const modulesInDB = await getAllData('modules');
            if (modulesInDB.length === 0) {
                console.log("Seeding database with new module data...");
                for (const module of seedModules) {
                    const cleanedPhrases = module.phrases.map(p => {
                        const kn_raw = p.kn || '';
                        const parts = kn_raw.split('(');
                        const kn_text = parts[0].trim();
                        return { ...p, kn: kn_text };
                    });
                    await addOrUpdate('modules', { ...module, phrases: cleanedPhrases });
                }
            }
            if (!await getData('userData', 'profile')) {
                await addOrUpdate('userData', { key: 'profile', name: 'Cara', streak: 0, wordsLearned: [], accuracy: { correct: 0, total: 0 }, useGoogleTTS: false });
            }
        }

        // --- UI & STATE ---
        const allViews = {
            dashboard: document.getElementById('dashboard-view'),
            lesson: document.getElementById('lesson-view'),
            authorMode: document.getElementById('author-mode-view'),
            game: document.getElementById('game-view'),
        };
        const flashcardActivity = document.getElementById('flashcard-activity');
        let currentModule = null, currentPhraseIndex = 0, isFlipped = false, lessonTimerInterval = null, lessonSeconds = 0;

        function showView(viewName) {
            Object.values(allViews).forEach(v => v.classList.add('hidden'));
            allViews[viewName].classList.remove('hidden');
        }

        async function renderDashboard() {
            const modulesGrid = document.getElementById('modules-grid');
            const modules = await getAllData('modules');
            modules.sort((a, b) => moduleOrder.indexOf(a.id) - moduleOrder.indexOf(b.id));

            modulesGrid.innerHTML = '';
            modules.forEach(module => {
                const card = document.createElement('div');
                card.className = 'bg-emerald-100 p-4 rounded-xl shadow-md text-center cursor-pointer hover:bg-emerald-200 transition';
                card.innerHTML = `<div class="text-4xl mb-2">${module.icon}</div><h3 class="font-bold">${module.title}</h3>`;
                card.addEventListener('click', () => startLesson(module.id));
                modulesGrid.appendChild(card);
            });
            
            const profile = await getData('userData', 'profile');
            document.getElementById('username-display').textContent = profile.name || 'Cara';
            document.getElementById('streak-days').textContent = profile.streak || 0;
            document.getElementById('words-learned').textContent = profile.wordsLearned?.length || 0;
            const acc = profile.accuracy;
            const accPercent = (acc && acc.total > 0) ? Math.round((acc.correct / acc.total) * 100) : 0;
            document.getElementById('accuracy-percent').textContent = `${accPercent}%`;
            await renderProgressVisuals();
            showView('dashboard');
        }
        
        async function renderProgressVisuals() {
            const progressLog = await getAllData('progressLog');
            const heatmapData = new Map();
            progressLog.forEach(log => heatmapData.set(log.date, log.minutes));

            const calendarContainer = document.getElementById('calendar-heatmap');
            calendarContainer.innerHTML = '';
            const today = new Date();
            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(today.getDate() - 60);
            
            let week = document.createElement('div');
            week.className = 'flex flex-col';
            
            for (let d = new Date(sixtyDaysAgo); d <= today; d.setDate(d.getDate() + 1)) {
                if (d.getDay() === 0 && week.children.length > 0) { calendarContainer.appendChild(week); week = document.createElement('div'); week.className = 'flex flex-col'; }
                const dayElem = document.createElement('div');
                const dateStr = d.toISOString().split('T')[0];
                const minutes = heatmapData.get(dateStr) || 0;
                const colorScale = d3.scaleLinear().domain([0, 1, 10]).range(['#E5E7EB', '#A7F3D0', '#10B981']);
                dayElem.className = 'w-4 h-4 m-0.5 rounded-sm heatmap-day';
                dayElem.style.backgroundColor = colorScale(minutes);
                dayElem.title = `${dateStr}: ${minutes} min`;
                week.appendChild(dayElem);
            }
            calendarContainer.appendChild(week);

            const chartContainer = document.getElementById('accuracy-chart');
            chartContainer.innerHTML = '';
            const accuracyData = progressLog.slice(-7).map(log => ({ date: log.date, acc: (log.accuracy.correct / log.accuracy.total) * 100 || 0 }));
            if (accuracyData.length > 0) {
                const maxAcc = d3.max(accuracyData, d => d.acc);
                const yScale = d3.scaleLinear().domain([0, Math.max(100, maxAcc)]).range([0, 192]);
                accuracyData.forEach(d => {
                    const bar = document.createElement('div');
                    bar.className = 'bg-emerald-400 rounded-t-md hover:bg-emerald-500 mx-1';
                    bar.style.width = `20px`;
                    bar.style.height = `${yScale(d.acc)}px`;
                    bar.title = `${d.date.slice(5)}: ${d.acc.toFixed(0)}%`;
                    chartContainer.appendChild(bar);
                });
            }
        }

        // --- LESSON LOGIC ---
        async function startLesson(moduleId) {
            currentModule = await getData('modules', moduleId);
            if (!currentModule || currentModule.phrases.length === 0) { showMessage("This module has no phrases yet."); return; }
            
            let phrases = [...currentModule.phrases];
            if (phrases.length > 10) {
                for (let i = phrases.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [phrases[i], phrases[j]] = [phrases[j], phrases[i]];
                }
                currentModule.lessonPhrases = phrases.slice(0, 10);
            } else {
                currentModule.lessonPhrases = phrases;
            }

            document.getElementById('lesson-title').textContent = currentModule.title;
            showView('lesson');
            document.getElementById('app-header').classList.add('hidden');
            
            lessonSeconds = 0;
            const timerDisplay = document.getElementById('lesson-timer');
            timerDisplay.textContent = '00:00';
            lessonTimerInterval = setInterval(() => {
                lessonSeconds++;
                const mins = String(Math.floor(lessonSeconds / 60)).padStart(2, '0');
                const secs = String(lessonSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${mins}:${secs}`;
            }, 1000);

            currentPhraseIndex = 0;
            nextActivity();
        }

        async function endLesson() {
            clearInterval(lessonTimerInterval);
            document.getElementById('app-header').classList.remove('hidden');
            
            const dateStr = new Date().toISOString().split('T')[0];
            let log = await getData('progressLog', dateStr) || { date: dateStr, minutes: 0, accuracy: { correct: 0, total: 0 } };
            log.minutes += Math.ceil(lessonSeconds / 60);
            const profile = await getData('userData', 'profile');
            log.accuracy = { ...profile.accuracy };
            await addOrUpdate('progressLog', log);

            showTrivia();
        }
        
        function showTrivia() {
            const trivia = karnatakaTrivia[Math.floor(Math.random() * karnatakaTrivia.length)];
            const modal = document.getElementById('trivia-modal');
            modal.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl w-96 text-center"><h3 class="text-lg font-bold mb-2">Did you know?</h3><p class="mb-2">${trivia.q}</p><p class="font-bold text-emerald-600 mb-4">${trivia.answer}</p><button id="trivia-close" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded">Continue</button></div>`;
            modal.classList.remove('hidden');
            modal.querySelector('#trivia-close').addEventListener('click', () => { modal.classList.add('hidden'); renderDashboard(); });
        }

        function nextActivity() {
            if (currentPhraseIndex >= currentModule.lessonPhrases.length) { endLesson(); return; }
            showFlashcard();
            currentPhraseIndex++;
        }

        async function updateProgress(wasCorrect, phraseId) {
            const profile = await getData('userData', 'profile');
            profile.accuracy.total++;
            if (wasCorrect) {
                profile.accuracy.correct++;
                if (!profile.wordsLearned.includes(phraseId)) profile.wordsLearned.push(phraseId);
                let srsData = await getData('srs', phraseId) || { phraseId, step: 0 };
                srsData.step++;
                const reviewIntervals = [1, 3, 7];
                const interval = reviewIntervals[Math.min(srsData.step - 1, reviewIntervals.length - 1)];
                const nextReviewDate = new Date();
                nextReviewDate.setDate(nextReviewDate.getDate() + interval);
                srsData.nextReview = nextReviewDate.toISOString().split('T')[0];
                srsData.lastReviewed = new Date().toISOString().split('T')[0];
                await addOrUpdate('srs', srsData);
            }
            await addOrUpdate('userData', profile);
        }
        
        const flashcardCanvas = document.getElementById('flashcard-canvas');
        const flashcardCtx = flashcardCanvas.getContext('2d');
        function drawFlashcard(phrase, showKannada) {
            const canvas = flashcardCanvas; canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; const ctx = flashcardCtx; ctx.fillStyle = '#FFFBEB'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#10B981'; ctx.textAlign = 'center';
            if (showKannada) { ctx.font = 'bold 32px Inter'; ctx.fillText(phrase.kn, canvas.width / 2, canvas.height / 2 - 20); ctx.font = '20px Inter'; ctx.fillStyle = '#6B7280'; ctx.fillText(phrase.translit, canvas.width / 2, canvas.height / 2 + 20); } else { ctx.font = 'bold 32px Inter'; ctx.fillText(phrase.en, canvas.width / 2, canvas.height / 2); }
            ctx.font = '14px Inter'; ctx.fillStyle = '#9CA3AF'; ctx.fillText('Tap to flip', canvas.width / 2, canvas.height - 20);
        }
        function showFlashcard() { flashcardActivity.classList.remove('hidden'); isFlipped = false; const phrase = currentModule.lessonPhrases[currentPhraseIndex]; drawFlashcard(phrase, isFlipped); }
        
        async function speakTTS(phrase) {
            const profile = await getData('userData', 'profile');
            if (!profile.useGoogleTTS || !GOOGLE_API_KEY || GOOGLE_API_KEY === "PASTE_YOUR_API_KEY_HERE") {
                if (profile.useGoogleTTS) console.warn("Google API Key not set. Using browser's default TTS.");
                const utterance = new SpeechSynthesisUtterance(phrase.kn);
                utterance.lang = 'kn-IN';
                window.speechSynthesis.speak(utterance);
                return;
            }

            const ttsApiUrl = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_API_KEY}`;
            const requestBody = {
                input: { text: phrase.kn },
                voice: { languageCode: 'kn-IN', name: 'kn-IN-Wavenet-A' }, // Female voice
                audioConfig: { audioEncoding: 'MP3' }
            };

            try {
                const response = await fetch(ttsApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const data = await response.json();
                if (data.audioContent) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
                    audio.play();
                }
            } catch (error) {
                console.error("Google TTS Error:", error);
                showMessage("Could not play high-quality audio. Please check API key and configuration.");
            }
        }

        function speak(phrase) {
            if (phrase && phrase.audioData) {
                const audio = new Audio(phrase.audioData);
                audio.play().catch(e => {
                    console.error("Audio playback failed:", e.name, e.message);
                    if (e.name === 'NotSupportedError') {
                        console.warn("Recorded audio format not supported, falling back to TTS.");
                        showMessage("Couldn't play recording, using default voice.");
                        speakTTS(phrase);
                    }
                });
            } else {
                speakTTS(phrase);
            }
        }
        if ('speechSynthesis' in window) window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

        // --- GAME LOGIC ---
        const gameContainer = document.getElementById('game-container');
        let activeGame = null, gameLoopId = null, timerIntervalId = null, gameState = {};

        function exitGame() {
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            if (timerIntervalId) clearInterval(timerIntervalId);
            activeGame = null;
            renderDashboard();
        }

        class Card {
            constructor(id, text, type, x, y, width, height) { this.id = id; this.text = text; this.type = type; this.x = x; this.y = y; this.width = width; this.height = height; this.state = 'hidden'; }
            draw(ctx) {
                ctx.strokeStyle = '#34D399'; ctx.lineWidth = 3; ctx.fillStyle = this.state === 'matched' ? '#A7F3D0' : (this.state === 'revealed' ? '#FFFBEB' : '#10B981');
                ctx.beginPath(); const r = 10; ctx.moveTo(this.x + r, this.y); ctx.arcTo(this.x + this.width, this.y, this.x + this.width, this.y + this.height, r); ctx.arcTo(this.x + this.width, this.y + this.height, this.x, this.y + this.height, r); ctx.arcTo(this.x, this.y + this.height, this.x, this.y, r); ctx.arcTo(this.x, this.y, this.x + this.width, this.y, r); ctx.closePath(); ctx.fill(); ctx.stroke();
                if (this.state === 'revealed') { ctx.fillStyle = '#1F2937'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = 'bold 16px Inter'; ctx.fillText(this.text, this.x + this.width / 2, this.y + this.height / 2); }
            }
            isClicked(mx, my) { return mx > this.x && mx < this.x + this.width && my > this.y && my < this.y + this.height; }
        }
        async function getPhrasesForGame(count) { const allModules = await getAllData('modules'); const allPhrases = allModules.flatMap(m => m.phrases).filter(p => p.en && p.kn); if (allPhrases.length < count) { showMessage(`You need at least ${count} phrases to play.`); return []; } return allPhrases.sort(() => 0.5 - Math.random()).slice(0, count); }
        
        function gameLoop() { 
            const gameCanvas = gameContainer.querySelector('#game-canvas');
            if (!gameCanvas) return;
            const gameCtx = gameCanvas.getContext('2d');
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height); 
            if (gameState.cards) gameState.cards.forEach(card => card.draw(gameCtx)); 
            if (!gameState.gameOver) gameLoopId = requestAnimationFrame(gameLoop); 
        }
        function updateTimer() { gameState.timeLeft--; gameContainer.querySelector('#game-timer').textContent = `Time: ${gameState.timeLeft}s`; if (gameState.timeLeft <= 0) { gameState.gameOver = true; clearInterval(timerIntervalId); showMessage(`Time's up! Final Score: ${gameState.score}`); exitGame(); } }
        function checkWinCondition() { const allMatched = gameState.cards.every(c => c.state === 'matched'); if (allMatched) { gameState.gameOver = true; gameState.score += activeGame === 'SpeedMatch' ? 5 : gameState.timeLeft; setTimeout(() => { showMessage(`You won! Final Score: ${gameState.score}`); exitGame(); }, 500); } }
        function setupGameCanvas() { 
            gameContainer.innerHTML = `
                <div class="flex justify-around mb-2 text-lg font-bold">
                    <div id="game-timer">Time: 60s</div>
                    <div id="game-score">Score: 0</div>
                </div>
                <canvas id="game-canvas" class="w-full h-96 rounded-lg bg-gray-100 cursor-pointer"></canvas>
            `;
            const gameCanvas = gameContainer.querySelector('#game-canvas');
            gameCanvas.width = gameCanvas.offsetWidth; 
            gameCanvas.height = gameCanvas.offsetHeight; 
            gameCanvas.addEventListener('click', (e) => { if (activeGame === 'SpeedMatch') handleSpeedMatchClick(e); else if (activeGame === 'MemoryGrid') handleMemoryGridClick(e); });
        }
        async function startSpeedMatchGame() { const phrases = await getPhrasesForGame(8); if (phrases.length === 0) return; activeGame = 'SpeedMatch'; document.getElementById('game-title').textContent = 'Speed Match'; showView('game'); setupGameCanvas(); const gameCanvas = gameContainer.querySelector('#game-canvas'); gameState = { cards: [], selected: [], score: 0, timeLeft: 60, gameOver: false }; gameContainer.querySelector('#game-score').textContent = 'Score: 0'; gameContainer.querySelector('#game-timer').textContent = 'Time: 60s'; let cardData = []; phrases.forEach(p => { cardData.push({ id: p.id, text: p.en, type: 'en' }); cardData.push({ id: p.id, text: p.kn, type: 'kn' }); }); cardData.sort(() => 0.5 - Math.random()); const cols = 4, rows = 4; const cardWidth = (gameCanvas.width - (cols + 1) * 10) / cols; const cardHeight = (gameCanvas.height - (rows + 1) * 10) / rows; for (let i = 0; i < cardData.length; i++) { const row = Math.floor(i / cols), col = i % cols; const x = col * (cardWidth + 10) + 10, y = row * (cardHeight + 10) + 10; gameState.cards.push(new Card(cardData[i].id, cardData[i].text, cardData[i].type, x, y, cardWidth, cardHeight)); } timerIntervalId = setInterval(updateTimer, 1000); gameLoopId = requestAnimationFrame(gameLoop); }
        function handleSpeedMatchClick(e) { if (gameState.gameOver || gameState.selected.length === 2) return; const gameCanvas = gameContainer.querySelector('#game-canvas'); const rect = gameCanvas.getBoundingClientRect(); const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top; for (const card of gameState.cards) { if (card.state === 'hidden' && card.isClicked(mouseX, mouseY)) { card.state = 'revealed'; gameState.selected.push(card); break; } } if (gameState.selected.length === 2) { const [c1, c2] = gameState.selected; if (c1.id === c2.id) { c1.state = 'matched'; c2.state = 'matched'; gameState.score += 10; gameContainer.querySelector('#game-score').textContent = `Score: ${gameState.score}`; gameState.selected = []; checkWinCondition(); } else { setTimeout(() => { c1.state = 'hidden'; c2.state = 'hidden'; gameState.selected = []; }, 500); } } }
        async function startMemoryGridGame() { const phrases = await getPhrasesForGame(8); if (phrases.length === 0) return; activeGame = 'MemoryGrid'; document.getElementById('game-title').textContent = 'Memory Grid'; showView('game'); setupGameCanvas(); const gameCanvas = gameContainer.querySelector('#game-canvas'); gameState = { cards: [], phase: 'study', timeLeft: 60, score: 0, gameOver: false, studyTime: 5 }; gameContainer.querySelector('#game-score').textContent = 'Score: 0'; gameContainer.querySelector('#game-timer').textContent = 'Memorize!'; const cols = 4, rows = 2; const cardWidth = (gameCanvas.width - (cols + 1) * 10) / cols; const cardHeight = (gameCanvas.height - (rows + 1) * 10) / rows; for (let i = 0; i < phrases.length; i++) { const row = Math.floor(i / cols), col = i % cols; const x = col * (cardWidth + 10) + 10, y = row * (cardHeight + 10) + 10; const card = new Card(phrases[i].id, phrases[i].kn, 'kn', x, y, cardWidth, cardHeight); card.phrase = phrases[i]; card.state = 'revealed'; gameState.cards.push(card); } setTimeout(() => { gameState.phase = 'recall'; gameState.cards.forEach(c => c.state = 'hidden'); timerIntervalId = setInterval(updateTimer, 1000); }, gameState.studyTime * 1000); gameLoopId = requestAnimationFrame(gameLoop); }
        async function handleMemoryGridClick(e) { if (gameState.gameOver || gameState.phase !== 'recall') return; const gameCanvas = gameContainer.querySelector('#game-canvas'); const rect = gameCanvas.getBoundingClientRect(); const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top; for (const card of gameState.cards) { if (card.state === 'hidden' && card.isClicked(mouseX, mouseY)) { const userAnswer = await showPrompt(`What is the English for "${card.text}"?`); if (userAnswer && userAnswer.toLowerCase().trim() === card.phrase.en.toLowerCase().trim()) { card.state = 'matched'; gameState.score += 5; } else { gameState.score -= 2; } gameContainer.querySelector('#game-score').textContent = `Score: ${gameState.score}`; checkWinCondition(); break; } } }

        // --- TRIVIA GAME LOGIC ---
        let triviaState = {};

        function startTriviaGame() {
            activeGame = 'Trivia';
            document.getElementById('game-title').textContent = 'Karnataka Trivia';
            showView('game');

            const shuffledTrivia = [...karnatakaTrivia].sort(() => 0.5 - Math.random());
            triviaState = {
                questions: shuffledTrivia.slice(0, 3),
                currentQuestionIndex: 0,
                score: 0
            };

            renderTriviaQuestion();
        }
        
        function renderTriviaQuestion() {
            if (triviaState.currentQuestionIndex >= triviaState.questions.length) {
                showMessage(`Trivia Complete! Your score: ${triviaState.score} / ${triviaState.questions.length}`);
                exitGame();
                return;
            }

            const questionData = triviaState.questions[triviaState.currentQuestionIndex];
            gameContainer.innerHTML = `
                <div class="text-center mb-4">
                    <p class="text-lg font-semibold">${questionData.q}</p>
                </div>
                <div id="trivia-options" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${questionData.options.map(opt => `<button class="trivia-option p-4 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-transparent shadow-sm text-lg">${opt}</button>`).join('')}
                </div>
                <div class="mt-4 text-center font-bold text-lg">Score: ${triviaState.score}</div>
            `;

            document.querySelectorAll('.trivia-option').forEach(button => {
                button.addEventListener('click', handleTriviaAnswer);
            });
        }

        function handleTriviaAnswer(e) {
            const selectedOption = e.target;
            const questionData = triviaState.questions[triviaState.currentQuestionIndex];
            const isCorrect = selectedOption.textContent === questionData.answer;

            document.querySelectorAll('.trivia-option').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === questionData.answer) {
                    btn.classList.add('correct-answer');
                }
            });

            if (isCorrect) {
                triviaState.score++;
                selectedOption.classList.add('correct-answer');
            } else {
                selectedOption.classList.add('incorrect-answer');
            }

            triviaState.currentQuestionIndex++;
            setTimeout(renderTriviaQuestion, 1500);
        }

        // --- AUTHOR MODE & MODALS ---
        let mediaRecorder;
        let audioChunks = [];

        async function renderAuthorEditor() { 
            const editor = document.getElementById('author-mode-view'); 
            const profile = await getData('userData', 'profile');
            const isTtsEnabled = profile.useGoogleTTS || false;

            editor.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Author Mode</h2><button id="exit-author-mode-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Exit</button></div>
                                <div class="mb-6 border-b pb-4">
                                    <h3 class="text-xl font-bold mb-2">Settings</h3>
                                    <div class="flex items-center justify-between">
                                        <label for="google-tts-toggle" class="font-semibold">Enable Google TTS</label>
                                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" name="google-tts-toggle" id="google-tts-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${isTtsEnabled ? 'checked' : ''}/>
                                            <label for="google-tts-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><button id="import-json-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Import JSON</button><input type="file" id="json-file-input" class="hidden" accept=".json"><button id="export-json-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Export JSON</button></div><h3 class="text-xl font-bold mb-2">Edit Modules & Phrases</h3><div id="author-content-editor" class="space-y-4"></div><button id="add-module-btn" class="mt-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">Add New Module</button><div class="mt-6 border-t pt-4"><h3 class="text-xl font-bold mb-2 text-red-600">Danger Zone</h3><button id="reset-progress-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Reset All Progress</button></div>`; 
            
            const contentEditor = document.getElementById('author-content-editor'); 
            const modules = await getAllData('modules'); 
            modules.sort((a, b) => moduleOrder.indexOf(a.id) - moduleOrder.indexOf(b.id));

            contentEditor.innerHTML = ''; 
            modules.forEach(module => { 
                const container = document.createElement('div'); 
                container.className = 'p-4 border rounded-lg'; 
                container.innerHTML = `<div class="flex justify-between items-center mb-2"><input class="text-xl font-bold border-b-2" value="${module.title}" data-module-id="${module.id}" data-field="title" /><input class="w-12 text-center border-b-2" value="${module.icon}" data-module-id="${module.id}" data-field="icon" /></div><div class="phrases-container space-y-2">${module.phrases.map((p, i) => `<div id="author-phrase-${module.id}-${i}" class="grid grid-cols-6 gap-2 items-center p-2 bg-gray-50 rounded"><input class="border rounded px-2 py-1" placeholder="English" value="${p.en}" data-module-id="${module.id}" data-phrase-index="${i}" data-field="en" /><input class="border rounded px-2 py-1" placeholder="Kannada" value="${p.kn}" data-module-id="${module.id}" data-phrase-index="${i}" data-field="kn" /><input class="border rounded px-2 py-1 col-span-2" placeholder="Transliteration" value="${p.translit || ''}" data-module-id="${module.id}" data-phrase-index="${i}" data-field="translit" />${p.audioData ? `<audio controls class="w-24 h-8" src="${p.audioData}"></audio>` : `<div class="w-24 h-8 audio-placeholder"></div>`}<div class="flex items-center gap-2"><button class="text-xl" data-record-btn data-module-id="${module.id}" data-phrase-index="${i}">üé§</button><button class="text-red-500 hover:font-bold" data-delete-btn data-module-id="${module.id}" data-phrase-index="${i}">X</button></div></div>`).join('')}</div><button class="mt-2 text-blue-500 hover:font-bold" data-add-phrase-btn data-module-id="${module.id}">Add Phrase</button>`; 
                contentEditor.appendChild(container); 
            }); 
            contentEditor.querySelectorAll('input').forEach(input => input.addEventListener('change', handleAuthorInputChange)); 
            contentEditor.querySelectorAll('[data-add-phrase-btn]').forEach(btn => btn.addEventListener('click', () => addPhrase(btn.dataset.moduleId))); 
            contentEditor.querySelectorAll('[data-delete-btn]').forEach(btn => btn.addEventListener('click', () => deletePhrase(btn.dataset.moduleId, btn.dataset.phraseIndex))); 
            contentEditor.querySelectorAll('[data-record-btn]').forEach(btn => btn.addEventListener('click', (e) => toggleRecording(e.target, btn.dataset.moduleId, btn.dataset.phraseIndex))); 
            document.getElementById('exit-author-mode-btn').addEventListener('click', renderDashboard); 
            document.getElementById('add-module-btn').addEventListener('click', async () => { const title = await showPrompt("Enter new module title:"); if (title) { const newModule = { id: title.toLowerCase().replace(/\s+/g, '-'), title, icon: '‚ú®', phrases: [] }; await addOrUpdate('modules', newModule); renderAuthorEditor(); } }); 
            document.getElementById('export-json-btn').addEventListener('click', exportToJson); 
            const jsonFileInput = document.getElementById('json-file-input'); 
            document.getElementById('import-json-btn').addEventListener('click', () => jsonFileInput.click()); 
            jsonFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (re) => { try { const data = JSON.parse(re.target.result); if (data.modules && Array.isArray(data.modules)) { for (const module of data.modules) await addOrUpdate('modules', module); } if (data.userData) await addOrUpdate('userData', data.userData); showMessage('Data imported successfully!'); renderAuthorEditor(); } catch (err) { showMessage('Error importing JSON: ' + err.message); } }; reader.readAsText(file); }); 
            document.getElementById('reset-progress-btn').addEventListener('click', resetAllProgress); 
            document.getElementById('google-tts-toggle').addEventListener('change', async (e) => {
                const profile = await getData('userData', 'profile');
                profile.useGoogleTTS = e.target.checked;
                await addOrUpdate('userData', profile);
                showMessage(`Google TTS ${e.target.checked ? 'Enabled' : 'Disabled'}.`);
            });
        }

        async function toggleRecording(button, moduleId, phraseIndex) {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                button.classList.remove("recording", "text-red-500");
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const options = { mimeType: 'audio/webm; codecs=opus' };
                    mediaRecorder = MediaRecorder.isTypeSupported(options.mimeType) ? new MediaRecorder(stream, options) : new MediaRecorder(stream);
                    mediaRecorder.start();
                    button.classList.add("recording", "text-red-500");
                    audioChunks = [];
                    mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
                    mediaRecorder.addEventListener("stop", async () => {
                        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = async function() {
                            const base64String = reader.result;
                            const module = await getData('modules', moduleId);
                            module.phrases[phraseIndex].audioData = base64String;
                            await addOrUpdate('modules', module);
                            
                            const phraseElement = document.getElementById(`author-phrase-${moduleId}-${phraseIndex}`);
                            if (phraseElement) {
                                const placeholder = phraseElement.querySelector('.audio-placeholder');
                                const existingAudio = phraseElement.querySelector('audio');
                                
                                const newAudio = document.createElement('audio');
                                newAudio.controls = true;
                                newAudio.className = 'w-24 h-8';
                                newAudio.src = base64String;

                                if (placeholder) {
                                    placeholder.replaceWith(newAudio);
                                } else if (existingAudio) {
                                    existingAudio.replaceWith(newAudio);
                                }
                            }
                        };
                        stream.getTracks().forEach(track => track.stop());
                    });
                } catch (err) {
                    showMessage("Microphone access denied or not available.");
                    console.error("Error accessing microphone:", err);
                }
            }
        }
        async function handleAuthorInputChange(e) { const { moduleId, field, phraseIndex } = e.target.dataset; const module = await getData('modules', moduleId); if (phraseIndex) module.phrases[parseInt(phraseIndex)][field] = e.target.value; else module[field] = e.target.value; await addOrUpdate('modules', module); }
        async function addPhrase(moduleId) { const module = await getData('modules',moduleId); const newId = module.phrases.length > 0 ? Math.max(...module.phrases.map(p => p.id)) + 1 : Date.now(); module.phrases.push({ id: newId, en: '', kn: '', translit: '' }); await addOrUpdate('modules', module); renderAuthorEditor(); }
        async function deletePhrase(moduleId, phraseIndex) { const confirmed = await showConfirm('Are you sure?'); if (confirmed) { const module = await getData('modules', moduleId); module.phrases.splice(phraseIndex, 1); await addOrUpdate('modules', module); renderAuthorEditor(); } }
        async function exportToJson() { const exportData = { modules: await getAllData('modules'), userData: await getData('userData', 'profile') }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = "kbb_export.json"; a.click(); }
        async function resetAllProgress() { const confirmed = await showConfirm("Are you sure you want to reset ALL progress? This cannot be undone."); if (confirmed) { await clearStore('userData'); await clearStore('srs'); await clearStore('progressLog'); await addOrUpdate('userData', { key: 'profile', name: 'Cara', streak: 0, wordsLearned: [], accuracy: { correct: 0, total: 0 }, useGoogleTTS: false }); showMessage("All progress has been reset."); renderDashboard(); } }
        function showMessage(text) { const modal = document.getElementById('message-modal'); modal.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl w-80"><p class="mb-4 text-center">${text}</p><button class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded">OK</button></div>`; modal.classList.remove('hidden'); modal.querySelector('button').addEventListener('click', () => modal.classList.add('hidden')); }
        function showConfirm(message) { return new Promise(resolve => { const modal = document.getElementById('confirm-modal'); modal.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl w-80"><p class="mb-4 text-center">${message}</p><div class="flex justify-end space-x-4"><button id="confirm-no-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">No</button><button id="confirm-yes-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Yes</button></div></div>`; modal.classList.remove('hidden'); modal.querySelector('#confirm-yes-btn').addEventListener('click', () => { modal.classList.add('hidden'); resolve(true); }); modal.querySelector('#confirm-no-btn').addEventListener('click', () => { modal.classList.add('hidden'); resolve(false); }); }); }
        function showPrompt(text) { return new Promise(resolve => { const modal = document.getElementById('prompt-modal'); modal.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl w-96"><p class="mb-4 text-center">${text}</p><input id="prompt-input" class="w-full p-2 border rounded mb-4"><div class="flex justify-end space-x-2"><button id="prompt-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button><button id="prompt-ok" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded">OK</button></div></div>`; modal.classList.remove('hidden'); const input = modal.querySelector('#prompt-input'); input.focus(); modal.querySelector('#prompt-ok').addEventListener('click', () => { modal.classList.add('hidden'); resolve(input.value); }); modal.querySelector('#prompt-cancel').addEventListener('click', () => { modal.classList.add('hidden'); resolve(null); }); input.addEventListener('keyup', (e) => { if (e.key === 'Enter') modal.querySelector('#prompt-ok').click(); }); }); }
        
        async function initApp() {
            await initDB();
            await seedDatabase();
            await renderDashboard();
            
            document.getElementById('exit-game-btn').addEventListener('click', exitGame);
            document.getElementById('speed-match-btn').addEventListener('click', startSpeedMatchGame);
            document.getElementById('memory-grid-btn').addEventListener('click', startMemoryGridGame);
            document.getElementById('trivia-game-btn').addEventListener('click', startTriviaGame);
            
            flashcardCanvas.addEventListener('click', () => { isFlipped = !isFlipped; const phrase = currentModule.lessonPhrases[currentPhraseIndex-1]; drawFlashcard(phrase, isFlipped); if (isFlipped) speak(phrase); });
            document.getElementById('flashcard-right').addEventListener('click', () => { updateProgress(true, currentModule.lessonPhrases[currentPhraseIndex-1].id); nextActivity(); });
            document.getElementById('flashcard-wrong').addEventListener('click', () => { updateProgress(false, currentModule.lessonPhrases[currentPhraseIndex-1].id); nextActivity(); });
            
            document.getElementById('author-mode-btn').addEventListener('click', () => {
                const modal = document.getElementById('passcode-modal');
                modal.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-80"><h3 class="text-xl font-bold mb-4 text-center">Enter Passcode</h3><input type="password" id="passcode-input" maxlength="4" class="w-full p-3 text-center text-2xl tracking-[1em] border-2 rounded-lg mb-2"><p id="passcode-error" class="text-red-500 h-5 text-center mb-4"></p><button id="passcode-submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">Enter</button><button id="passcode-close" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mt-2">Cancel</button></div>`;
                modal.classList.remove('hidden');
                const input = modal.querySelector('#passcode-input');
                input.focus();
                modal.querySelector('#passcode-close').addEventListener('click', () => modal.classList.add('hidden'));
                modal.querySelector('#passcode-submit').addEventListener('click', () => { if (input.value === '1104') { modal.classList.add('hidden'); showView('authorMode'); renderAuthorEditor(); } else { modal.querySelector('#passcode-error').textContent = 'Incorrect passcode.'; } });
                input.addEventListener('keyup', (e) => { if (e.key === 'Enter') modal.querySelector('#passcode-submit').click(); });
            });
            
            const profilePic = document.getElementById('profile-pic');
            const profilePicInput = document.getElementById('profile-pic-input');
            document.getElementById('user-profile').addEventListener('click', async (e) => {
                if (e.target.id === 'username-display') {
                    const newName = await showPrompt("What's your name?");
                    if (newName) { const profile = await getData('userData', 'profile'); profile.name = newName; await addOrUpdate('userData', profile); document.getElementById('username-display').textContent = newName; }
                } else {
                    profilePicInput.click();
                }
            });
            profilePicInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) { const reader = new FileReader(); reader.onload = (re) => { const imageData = re.target.result; localStorage.setItem('profilePic', imageData); profilePic.src = imageData; }; reader.readAsDataURL(file); }
            });
            const savedPic = localStorage.getItem('profilePic');
            if (savedPic) profilePic.src = savedPic;
        }

        initApp();
    });
    </script>
</body>
</html>
